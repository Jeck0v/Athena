DEPLOYMENT-ID SWARM_ADVANCED_TEST
VERSION-ID 2.1.0

ENVIRONMENT SECTION
NETWORK-NAME production_overlay DRIVER OVERLAY ATTACHABLE TRUE ENCRYPTED TRUE

SERVICES SECTION

SERVICE load_balancer
IMAGE-ID nginx:alpine
REPLICAS 2
UPDATE-CONFIG PARALLELISM 1 DELAY 30s FAILURE-ACTION ROLLBACK MONITOR 60s MAX-FAILURE-RATIO 0.2
SWARM-LABELS tier="proxy" environment="production" critical="true"
PORT-MAPPING 80 TO 80
PORT-MAPPING 443 TO 443
DEPENDS-ON api_gateway
END SERVICE

SERVICE api_gateway
BUILD-ARGS NODE_ENV="production" API_VERSION="v2.1"
REPLICAS 5
UPDATE-CONFIG PARALLELISM 2 DELAY 15s FAILURE-ACTION ROLLBACK MONITOR 30s
SWARM-LABELS tier="api" environment="production" scaling="auto"
DEPENDS-ON user_service
DEPENDS-ON order_service
END SERVICE

SERVICE user_service
IMAGE-ID python:3.11-slim
REPLICAS 3
UPDATE-CONFIG PARALLELISM 1 DELAY 20s FAILURE-ACTION PAUSE
SWARM-LABELS tier="backend" service="users" environment="production"
RESOURCE-LIMITS CPU "0.5" MEMORY "512M"
DEPENDS-ON database
END SERVICE

SERVICE order_service
IMAGE-ID java:17-jdk-slim
REPLICAS 4
UPDATE-CONFIG PARALLELISM 2 DELAY 25s FAILURE-ACTION CONTINUE
SWARM-LABELS tier="backend" service="orders" environment="production"
RESOURCE-LIMITS CPU "1.0" MEMORY "1024M"
DEPENDS-ON database
END SERVICE

SERVICE database
IMAGE-ID postgres:15
REPLICAS 1
UPDATE-CONFIG PARALLELISM 1 DELAY 60s FAILURE-ACTION PAUSE
SWARM-LABELS tier="data" role="primary" critical="true" environment="production"
RESOURCE-LIMITS CPU "2.0" MEMORY "2048M"
END SERVICE