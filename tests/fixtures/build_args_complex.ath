DEPLOYMENT-ID BUILD_ARGS_COMPLEX
VERSION-ID 2.0.0

ENVIRONMENT SECTION
NETWORK-NAME custom_network

SERVICES SECTION

SERVICE web_server
BUILD-ARGS NGINX_VERSION="1.25" CONFIG_ENV="prod" WORKER_PROCESSES="4"
PORT-MAPPING 80 TO 80
PORT-MAPPING 443 TO 443
HEALTH-CHECK "curl -f http://localhost/health"
RESTART-POLICY always
DEPENDS-ON app
END SERVICE

SERVICE app
BUILD-ARGS NODE_VERSION="20" APP_ENV="production" PORT="3000" WORKERS="2"
PORT-MAPPING 3000 TO 3000
ENV-VARIABLE {{API_SECRET}}
ENV-VARIABLE {{DATABASE_URL}}
RESOURCE-LIMITS CPU "1.0" MEMORY "512M"
DEPENDS-ON redis
DEPENDS-ON cache
END SERVICE

SERVICE redis
IMAGE-ID "redis:7-alpine"
PORT-MAPPING 6379 TO 6379
RESTART-POLICY always
END SERVICE

SERVICE cache
BUILD-ARGS MEMCACHED_VERSION="1.6" MEMORY_LIMIT="128m"
PORT-MAPPING 11211 TO 11211
RESTART-POLICY always
END SERVICE